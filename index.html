<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <style>
      .arrowRight:hover {
        fill: #201e1f;
        stroke: black;
        opacity: 1;
      }
    </style>
  </head>

  <body>
    <svg
      id="svgOne"
      xmlns="http://www.w3.org/2000/svg"
      width="900"
      height="600"
      viewBox="0 0 900 600"
    >
      <defs>
        <circle id="myCircle" cx="0" cy="0" r="15" />
        <path d="M15.41 16.59L10.83 12l4.58-4.59L14 6l-6 6 6 6 1.41-1.41z" />

        <g id="arrowRight" transform="scale(0.05) translate(0,-40)" fill="grey">
          <circle
            style="fill:rgb(15, 15, 15);"
            cx="236.827"
            cy="236.827"
            r="236.827"
          />
          <path
            style="fill:#FFFFFF;"
            d="M333.577,219.408c-35.885-35.885-71.77-71.766-107.659-107.651
        	c-25.564-25.56-65.084,14.259-39.456,39.883c29.236,29.236,58.479,58.476,87.719,87.712c-29.315,29.307-58.625,58.618-87.929,87.925
        	c-25.564,25.56,14.255,65.08,39.879,39.456c35.889-35.885,71.774-71.77,107.659-107.655
        	C344.635,248.237,344.34,230.171,333.577,219.408z"
          />
        </g>

        <g id="arrowLeft" transform="scale(0.05) translate(0,-40)" fill="grey">
          <circle
            style="fill:rgb(15, 15, 15);"
            cx="236.827"
            cy="236.827"
            r="236.827"
          />
          <path
            style="fill:#FFFFFF;"
            <path
            style="fill:#FFFFFF;"
            d="M214.181,240.332c29.429-29.425,58.857-58.853,88.278-88.278
	c25.666-25.663-14.316-65.341-40.039-39.615c-36.029,36.029-72.055,72.055-108.084,108.084
	c-10.888,10.885-10.588,29.023,0.214,39.829c36.029,36.029,72.055,72.058,108.084,108.087
	c25.666,25.666,65.345-14.316,39.615-40.043C272.888,299.039,243.535,269.686,214.181,240.332z"
          />

          />
        </g>

        <path d="M14 7l-5 5 5 5V7z" />
        <path fill="none" d="M0 0h24v24H0V0z" />
        <path d="M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.41z" />

        <path d="M10 17l5-5-5-5v10z" />
        <path
          id="arrow"
          d="M345.441,248.292L151.154,442.573c-12.359,12.365-32.397,12.365-44.75,0c-12.354-12.354-12.354-32.391,0-44.744
		L278.318,225.92L106.409,54.017c-12.354-12.359-12.354-32.394,0-44.748c12.354-12.359,32.391-12.359,44.75,0l194.287,194.284
		c6.177,6.18,9.262,14.271,9.262,22.366C354.708,234.018,351.617,242.115,345.441,248.292z"
        />
        <linearGradient id="myGradient" gradientTransform="rotate(90)">
          <stop offset="100%" stop-color="black" />
          <stop offset="0%" stop-color="gray" />
        </linearGradient>
      </defs>
      <rect x="0" y="0" width="100%" height="100%" fill="#052838" />
    </svg>
    <script>
      var svgns = 'http://www.w3.org/2000/svg';
      var x = 0;
      var y = 0;
      var h = 40;
      var w = 150;
      var DrawGrid = true;
      var ROOT = document.getElementById('svgOne');
      var bBox = ROOT.getBBox();
      console.log('XxY', bBox.x + 'x' + bBox.y);
      console.log('size', bBox.width + 'x' + bBox.height);

      var COLUMNS = 7;
      var roundSize = parseInt(bBox.width / COLUMNS);
      var debugText = null;
      var DEBUG = true;
      if (DEBUG) {
        debugText = document.createElementNS(
          'http://www.w3.org/2000/svg',
          'text'
        );
        debugText.setAttribute('x', bBox.width - 150);
        debugText.setAttribute('y', 50);
        debugText.setAttribute('fill', '#fff');
        debugText.textContent = '--x--';
        ROOT.appendChild(debugText);
      }

      if (DrawGrid) {
        for (var i = 0; i < COLUMNS + 1; i++) {
          var l = createLine(i * roundSize, 0, i * roundSize, bBox.height);
          document.getElementById('svgOne').appendChild(l);
        }
      }

      for (var i = 0; i < 10; i++) {
        var rect = document.createElementNS(svgns, 'rect');
        var color = '#' + Math.round(0xffffff * Math.random()).toString(16);
        rect.setAttributeNS(null, 'x', x);
        rect.setAttributeNS(null, 'y', y);
        rect.setAttributeNS(null, 'height', h);
        rect.setAttributeNS(null, 'width', w);
        rect.setAttributeNS(null, 'fill', color);
        document.getElementById('svgOne').appendChild(rect);

        var circleStart = document.createElementNS(svgns, 'circle');
        circleStart.setAttributeNS(null, 'cx', x);
        circleStart.setAttributeNS(null, 'cy', y + h / 2);
        circleStart.setAttributeNS(null, 'r', h / 2);
        //circle.setAttributeNS(null, 'style', 'fill: none; stroke: blue; stroke-width: 1px;' );
        circleStart.setAttributeNS(null, 'fill', color);
        circleStart.setAttributeNS(null, 'class', 'hoverEffect');
        document.getElementById('svgOne').appendChild(circleStart);

        var circleEnd = document.createElementNS(svgns, 'circle');
        circleEnd.setAttributeNS(null, 'cx', x + w);
        circleEnd.setAttributeNS(null, 'cy', y + h / 2);
        circleEnd.setAttributeNS(null, 'r', h / 2);
        circleEnd.setAttributeNS(null, 'class', 'hoverEffect');
        //circleEnd.setAttributeNS(null, 'style', 'fill: none; stroke: blue; stroke-width: 1px;' );
        circleEnd.setAttributeNS(null, 'fill', color);

        //circleStart.style.stroke = 'black';
        circleStart.style.stroke.width = '3';
        //circleEnd.style.stroke = 'black';
        //circleEnd.style.stroke.width = '3';
        document.getElementById('svgOne').appendChild(circleEnd);

        var scale = 1;

        var startArrow = createUseElement({
          x: x - 10,
          y: y + h / 2 - 10,
          href: 'arrowLeft',
          fillId: 'myGradient',
          scale: scale
        });
        document.getElementById('svgOne').appendChild(startArrow);

        var endArrow = createUseElement({
          x: x + w - 10,
          y: y + h / 2 - 10,
          href: 'arrowRight',
          fillId: 'myGradient',
          scale: scale
        });
        document.getElementById('svgOne').appendChild(endArrow);

        makeDraggable(rect, circleStart, circleEnd, startArrow, endArrow, {
          scale: 1
        });

        y += h;
        x += 10;
      }

      function createLine(x1, y1, x2, y2, color, strokeWidth) {
        var l = document.createElementNS('http://www.w3.org/2000/svg', 'line');
        l.setAttribute('x1', x1);
        l.setAttribute('y1', y1);
        l.setAttribute('x2', x2);
        l.setAttribute('y2', y2);
        l.setAttribute('stroke', color || 'black');
        l.setAttribute('stroke-width', strokeWidth || 2);
        return l;
      }
      function createUseElement(options) {
        //<use x="200" y="15" xlink:href="#myCircle" fill="url('#myGradient')" />
        var xmlns = 'http://www.w3.org/2000/svg';
        var xlinkns = 'http://www.w3.org/1999/xlink';
        var use = document.createElementNS(xmlns, 'use');

        var scale = options.scale || 1;
        var angle = options.angle || 0;
        var s =
          'scale(' + scale + ') rotate(' + angle + ' ' + 0 + ' ' + 0 + ')';
        use.setAttributeNS(null, 'transform', s);
        use.setAttributeNS(null, 'class', 'hoverEffect');
        use.setAttributeNS(null, 'id', 'arrowRight');

        //use.setAttributeNS(null, 'transform-origin', '50% 50%');
        //   var t =
        //     'translate(' +
        //     randomPos(width) +
        //     ',' +
        //     randomPos(height) +
        //     ') ' +
        //     'scale(' +
        //     randomScaleNamed(name) +
        //     ')';
        //use.setAttributeNS(null, 'class', name);
        use.setAttributeNS(null, 'x', options.x * (1 / scale));
        use.setAttributeNS(null, 'y', options.y * (1 / scale));
        use.setAttributeNS(xlinkns, 'xlink:href', '#' + options.href);
        use.setAttributeNS(null, 'fill', `url('#${options.fillId}')`);
        return use;
      }

      function makeDraggable(
        middle,
        start,
        end,
        arrowStart,
        arrowEnd,
        options
      ) {
        var scale = options.scale;
        var middleRect = middle;
        var startCircle = start;
        var endCircle = end;
        var svgRoot = document.getElementById('svgOne');
        svgRoot.addEventListener('mouseup', endDrag);
        svgRoot.addEventListener('mousemove', drag);

        middleRect.addEventListener('mousedown', startDrag);
        arrowStart.addEventListener('mousedown', startDragStartArrow);
        arrowEnd.addEventListener('mousedown', startDragEndArrow);
        //middleRect.addEventListener('mousemove', drag);
        //middleRect.addEventListener('mouseup', endDrag);
        //middleRect.addEventListener('mouseleave', endDrag);

        //startCircle.addEventListener('mousedown', startDragStartArrow);
        //
        //startCircle.addEventListener('mouseup', endDragStartArrow);
        //startCircle.addEventListener('mouseleave', endDragStartArrow);

        //endCircle.addEventListener('mousemove', dragEndArrow);

        var startCircleSelected, initialStateDragStart;
        var endCircleSelected, initialStateDragEnd;
        var centerRect, offset;

        function startDragStartArrow(evt) {
          startCircleSelected = startCircle; //evt.target;
          initialStateDragStart = getMousePosition(evt);
          initialStateDragStart.w = middleRect.getAttributeNS(null, 'width');
          initialStateDragStart.middleRectStartX = parseFloat(
            middleRect.getAttributeNS(null, 'x')
          );
          initialStateDragStart.offsetX = initialStateDragStart.x;
          initialStateDragStart.arrowOffsetX = initialStateDragStart.x;
          initialStateDragStart.offsetX -= parseFloat(
            startCircle.getAttributeNS(null, 'cx')
          );
          initialStateDragStart.y -= parseFloat(
            startCircle.getAttributeNS(null, 'cy')
          );
          initialStateDragStart.arrowOffsetX -= arrowStart.getAttributeNS(
            null,
            'x'
          );
        }

        function startDragEndArrow(evt) {
          endCircleSelected = endCircle; //evt.target;
          initialStateDragEnd = getMousePosition(evt);
          initialStateDragEnd.w = middleRect.getAttributeNS(null, 'width');
          initialStateDragEnd.offsetX = initialStateDragEnd.x;
          initialStateDragEnd.arrowOffsetX = initialStateDragEnd.x;
          initialStateDragEnd.offsetX -= parseFloat(
            endCircle.getAttributeNS(null, 'cx')
          );
          initialStateDragEnd.y -= parseFloat(
            endCircle.getAttributeNS(null, 'cy')
          );
          initialStateDragEnd.arrowOffsetX -= arrowEnd.getAttributeNS(
            null,
            'x'
          );
        }

        function startDrag(evt) {
          centerRect = evt.target;
          offset = getMousePosition(evt);
          offset.s = offset.x; //parseFloat(middleRect.getAttributeNS(null, 'x'));
          console.log('start Drag', offset.s);
          offset.x -= parseFloat(centerRect.getAttributeNS(null, 'x'));
          offset.y -= parseFloat(centerRect.getAttributeNS(null, 'y'));
        }

        //https://www.sitepoint.com/how-to-translate-from-dom-to-svg-coordinates-and-back-again/
        //clientX and clientY are dome coordinate system in pixels
        function getMousePosition(evt) {
          var CTM = svgRoot.getScreenCTM();
          return {
            x: (evt.clientX - CTM.e) / CTM.a,
            y: (evt.clientY - CTM.f) / CTM.d
          };
        }

        function drag(evt) {
          var coord = getMousePosition(evt);
          debugText.textContent = coord.x + 'x' + coord.y;
          handleDrag(coord);
        }

        function handleDrag(coord, final) {
          if (startCircleSelected) {
            //evt.preventDefault();

            var dt = parseFloat(initialStateDragStart.x) - parseFloat(coord.x);

            middleRect.setAttributeNS(
              null,
              'width',
              parseFloat(initialStateDragStart.w) + parseFloat(dt)
            );
            console.log(
              'middleRectStartX: ' + initialStateDragStart.middleRectStartX
            );
            middleRect.setAttributeNS(
              null,
              'x',
              initialStateDragStart.middleRectStartX - dt
            );

            startCircle.setAttributeNS(
              null,
              'cx',
              coord.x - initialStateDragStart.offsetX
            );

            var xEndArrowBefore = parseFloat(
              arrowStart.getAttributeNS(null, 'x')
            );

            arrowStart.setAttributeNS(
              null,
              'x',
              coord.x - initialStateDragStart.arrowOffsetX
            );
          }
          if (endCircleSelected) {
            //evt.preventDefault();
            console.log('handle drag end: coord.x: ' + coord.x);
            var dt = parseFloat(coord.x) - parseFloat(initialStateDragEnd.x);
            middleRect.setAttributeNS(
              null,
              'width',
              parseFloat(initialStateDragEnd.w) + parseFloat(dt)
            );

            endCircle.setAttributeNS(
              null,
              'cx',
              coord.x - initialStateDragEnd.offsetX
            );

            var xEndArrowBefore = parseFloat(
              arrowEnd.getAttributeNS(null, 'x')
            );
            arrowEnd.setAttributeNS(
              null,
              'x',
              coord.x - initialStateDragEnd.arrowOffsetX
            );
            console.log(
              'circle -> : ' + parseFloat(circleEnd.getAttributeNS(null, 'cx'))
            );
          }
          if (centerRect) {
            //evt.preventDefault();
            var xBefore = parseFloat(centerRect.getAttributeNS(null, 'x'));
            console.log('handle drag center: coord.x: ' + coord.x);
            var dtDrag = parseInt(coord.x) - xBefore - offset.x; //parseInt(offset.s);
            if (final) {
              var current = parseFloat(startCircle.getAttributeNS(null, 'cx'));
              dtDrag = coord.x - current + h / 2;
              console.log('current: ' + current);
              console.log('dtDrag: ' + dtDrag);
            }

            //console.log('offset.s: ' + offset.s);

            //centerRect.setAttributeNS(null, 'x', coord.x - offset.x);
            // console.log('xBefore: ' + xBefore);
            // let sum = Number(xBefore) + Number(dtDrag);
            // console.log('sum: ', sum);
            if (final) {
              centerRect.setAttributeNS(null, 'x', xBefore + dtDrag);
            } else {
              centerRect.setAttributeNS(null, 'x', xBefore + dtDrag);
            }

            var xAfter = parseFloat(centerRect.getAttributeNS(null, 'x'));

            var dt = xAfter - xBefore;

            var xStartCircle = parseFloat(
              startCircle.getAttributeNS(null, 'cx')
            );
            startCircle.setAttributeNS(null, 'cx', xStartCircle + dt);

            var xEndCircle = parseFloat(endCircle.getAttributeNS(null, 'cx'));
            endCircle.setAttributeNS(null, 'cx', xEndCircle + dt);

            var xStartArrow = parseFloat(arrowStart.getAttributeNS(null, 'x'));
            arrowStart.setAttributeNS(null, 'x', xStartArrow + dt);

            var xEndArrow = parseFloat(arrowEnd.getAttributeNS(null, 'x'));
            arrowEnd.setAttributeNS(null, 'x', xEndArrow + dt);

            //selectedElement.setAttributeNS(null, "y", coord.y - offset.y);
          }
        }

        function round(x) {
          //console.log('x: ' + x);
          //console.log('x round: ' + (x - (x % roundSize)));
          return x - parseInt(x % roundSize);
        }
        function roundUp(px) {
          //console.log('x: ' + x);
          //console.log('x round: ' + (x - (x % roundSize)));
          return px - parseInt(px % roundSize) + roundSize;
        }

        function endDrag(evt) {
          //console.log('endDrag');

          if (centerRect) {
            console.log('centerRect');
            var x = parseFloat(centerRect.getAttributeNS(null, 'x'));
            x = round(x);
            var coord = {
              x: x
            };
            handleDrag(coord, true);
          }
          if (endCircleSelected) {
            console.log('endCircleSelected');
            var cx = parseFloat(endCircleSelected.getAttributeNS(null, 'cx'));
            console.log('before round: ' + cx);
            cx = roundUp(cx);
            console.log('after round: ' + cx);
            var coord = {
              x: cx - h / 2
            };
            handleDrag(coord, true);
          }
          if (startCircleSelected) {
            console.log('startCircleSelected');
            var ccx = parseFloat(
              startCircleSelected.getAttributeNS(null, 'cx')
            );
            ccx = round(ccx);
            var coord = {
              x: ccx + h / 2
            };
            handleDrag(coord, true);
          }
          centerRect = null;
          endCircleSelected = null;
          startCircleSelected = null;
        }
      }
    </script>
  </body>
</html>
